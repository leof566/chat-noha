<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat familiar</title>
  <style>
    :root {
      --bg:#0f172a; --text:#e5e7eb; --panel:#111827; --panel-border:#1f2937; --accent:#22c55e; --bubble-me: var(--accent); --bubble-other:#1f2937; --meta:#94a3b8;
      font-family: system-ui, Arial, sans-serif;
    }
    .light { --bg:#f8fafc; --text:#0b0f1a; --panel:#ffffff; --panel-border:#e5e7eb; --bubble-me: var(--accent); --bubble-other:#e5e7eb; --meta:#475569; }
    * { box-sizing: border-box; }
    body { margin: 0; background:var(--bg); color:var(--text); display:flex; min-height:100vh; }
    .card { max-width:820px; margin:auto; width:100%; padding:16px; display:flex; flex-direction:column; gap:16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header h1 { font-size:18px; margin:0; }
    header small { opacity:.7; }
    button { cursor:pointer; border:0; padding:10px 14px; border-radius:10px; }
    .btn { background:var(--accent); color:#0b101f; font-weight:600; }
    .btn-sec { background:var(--panel-border); color:var(--text); }
    .panel { background:var(--panel); border:1px solid var(--panel-border); border-radius:14px; padding:16px; }
    .stack { display:flex; flex-direction:column; gap:12px; }
    input, select, .input { width:100%; background:transparent; color:var(--text); border:1px solid var(--panel-border); border-radius:10px; padding:12px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; }
    #messages { height:55vh; overflow-y:auto; display:flex; flex-direction:column; gap:10px; padding:8px; background:transparent; border-radius:12px; border:1px solid var(--panel-border); }
    .msg { max-width:80%; padding:10px 12px; border-radius:12px; line-height:1.35; word-wrap:break-word; white-space:pre-wrap; }
    .me { align-self:flex-end; background:var(--bubble-me); color:#0b101f; }
    .other { align-self:flex-start; background:var(--bubble-other); color:var(--text); }
    .meta { font-size:12px; color:var(--meta); margin-top:4px; }
    footer { display:flex; gap:8px; }
    .settings { display:grid; grid-template-columns: 1fr; gap:8px; }
    @media (min-width: 640px){ .settings { grid-template-columns: 1fr 1fr 1fr 1fr auto auto; align-items:end; } }
    label { font-size:12px; opacity:.8; display:block; margin-bottom:6px; }
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h1>Chat familiar (3 personas)</h1>
        <small id="status">Desconectado</small>
      </div>
      <div class="row">
        <button id="enableSoundBtn" class="btn-sec" title="Habilita un bip en nuevos mensajes">Activar sonido</button>
        <button id="enablePushBtn" class="btn-sec" title="Activa push reales (opcional)">Activar push</button>
        <button id="logoutBtn" class="btn-sec" style="display:none">Salir</button>
      </div>
    </header>

    <!-- AJUSTES (alias, tema, color) -->
    <section class="panel">
      <div class="settings">
        <div>
          <label>Alias visible</label>
          <input id="aliasInput" placeholder="Ej: Papá / Mamá / Juan" />
        </div>
        <div>
          <label>Tema</label>
          <select id="themeSelect">
            <option value="dark">Oscuro</option>
            <option value="light">Claro</option>
          </select>
        </div>
        <div>
          <label>Color de acento</label>
          <input id="accentPicker" type="color" value="#22c55e" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="savePrefsBtn" class="btn">Guardar ajustes</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <small>El alias se guarda en tu perfil. El tema/color quedan guardados en este dispositivo.</small>
        </div>
      </div>
    </section>

    <!-- PANEL DE LOGIN/REGISTRO -->
    <section id="auth" class="panel stack">
      <strong>Ingresar</strong>
      <input id="email" type="email" placeholder="Email" />
      <input id="pass" type="password" placeholder="Contraseña" />
      <div class="row">
        <button id="loginBtn" class="btn">Iniciar sesión</button>
        <button id="registerBtn" class="btn-sec" title="Usalo una sola vez para crear la cuenta">Crear cuenta</button>
      </div>
      <small>Creá 3 cuentas: vos, tu hijo y la madre. Luego poné sus UID en el room.</small>
    </section>

    <!-- PANEL DEL CHAT -->
    <section id="chat" style="display:none" class="stack">
      <div id="messages"></div>
      <footer>
        <input id="text" class="input" placeholder="Escribí tu mensaje y Enter…" />
        <button id="sendBtn" class="btn">Enviar</button>
      </footer>
    </section>
  </div>

  <script type="module">
    // --- IMPORTES FIREBASE ---
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { isSupported, getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging.js';

    // --- CONFIGURACIÓN FIREBASE (PEGÁ LA TUYA AQUÍ) ---
    const firebaseConfig = {
      apiKey: "PEGAR_AQUI_apiKey",
      authDomain: "PEGAR_AQUI_authDomain",
      projectId: "PEGAR_AQUI_projectId",
      storageBucket: "PEGAR_AQUI_storageBucket",
      messagingSenderId: "PEGAR_AQUI_messagingSenderId",
      appId: "PEGAR_AQUI_appId"
    };

    // Sala en Firestore: /rooms/familia (con members = [uid1, uid2, uid3])
    const ROOM_ID = 'familia';

    // (Opcional) Clave VAPID pública para push reales (FCM)
    const VAPID_KEY = 'PEGAR_AQUI_TU_VAPID_PUBLICA';

    // --- INICIALIZACIÓN ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- UI REFS ---
    const authPanel = document.getElementById('auth');
    const chatPanel = document.getElementById('chat');
    const statusEl = document.getElementById('status');
    const messagesEl = document.getElementById('messages');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('pass');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const textEl = document.getElementById('text');
    const sendBtn = document.getElementById('sendBtn');
    const aliasInput = document.getElementById('aliasInput');
    const themeSelect = document.getElementById('themeSelect');
    const accentPicker = document.getElementById('accentPicker');
    const savePrefsBtn = document.getElementById('savePrefsBtn');
    const enablePushBtn = document.getElementById('enablePushBtn');
    const enableSoundBtn = document.getElementById('enableSoundBtn');

    let unsubMessages = null;

    // --- TEMA & COLOR ---
    function applyTheme(theme = localStorage.getItem('theme') || 'dark', accent = localStorage.getItem('accent') || '#22c55e') {
      document.body.classList.toggle('light', theme === 'light');
      document.documentElement.style.setProperty('--accent', accent);
      themeSelect.value = theme; accentPicker.value = accent;
    }
    applyTheme();

    savePrefsBtn.onclick = async () => {
      const theme = themeSelect.value; const accent = accentPicker.value;
      localStorage.setItem('theme', theme); localStorage.setItem('accent', accent);
      applyTheme(theme, accent);
      // guarda alias si estás logueado
      if (auth.currentUser) {
        const uid = auth.currentUser.uid;
        const uref = doc(db, 'users', uid);
        await setDoc(uref, { alias: aliasInput.value || aliasFromEmail(auth.currentUser.email) }, { merge: true });
        alert('Ajustes guardados');
      } else {
        alert('Tema/Color guardados en este dispositivo');
      }
    };

    // --- AUDIO (bip local) ---
    let audioCtx = null;
    function initAudio(){
      try{
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        // desbloquear en iOS/Android
        const buf = audioCtx.createBuffer(1, 1, 22050);
        const src = audioCtx.createBufferSource();
        src.buffer = buf; src.connect(audioCtx.destination); src.start(0);
        localStorage.setItem('soundEnabled','1');
        enableSoundBtn.textContent = 'Sonido activado';
        enableSoundBtn.disabled = true;
      }catch(e){ alert('No se pudo activar sonido: ' + e.message); }
    }
    function beep(){
      if (!audioCtx || localStorage.getItem('soundEnabled')!=='1') return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type = 'sine'; o.frequency.value = 880;
      const now = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.18, now + 0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.15);
      o.start(); o.stop(now + 0.16);
      if (navigator.vibrate) { try{ navigator.vibrate([120, 60, 120]); }catch{} }
    }
    enableSoundBtn.onclick = initAudio;

    // --- AUTENTICACIÓN ---
    loginBtn.onclick = async () => {
      if (!emailEl.value || !passEl.value) return alert('Completá email y contraseña');
      try { await signInWithEmailAndPassword(auth, emailEl.value, passEl.value); }
      catch (e) { alert('Error al iniciar: ' + e.message); }
    };

    registerBtn.onclick = async () => {
      if (!emailEl.value || !passEl.value) return alert('Completá email y contraseña');
      try {
        const cred = await createUserWithEmailAndPassword(auth, emailEl.value, passEl.value);
        // crea perfil con alias por defecto
        await setDoc(doc(db, 'users', cred.user.uid), { alias: aliasFromEmail(emailEl.value) });
        alert('Cuenta creada. Ahora podés iniciar sesión.');
      } catch (e) { alert('Error al registrar: ' + e.message); }
    };

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        statusEl.textContent = `Conectado como ${user.email}`;
        authPanel.style.display = 'none';
        chatPanel.style.display = 'flex';
        logoutBtn.style.display = 'inline-block';
        await ensureProfile();
        suscribirMensajes();
        try { if ('Notification' in window) await Notification.requestPermission(); } catch {}
      } else {
        statusEl.textContent = 'Desconectado';
        authPanel.style.display = 'block';
        chatPanel.style.display = 'none';
        logoutBtn.style.display = 'none';
        messagesEl.innerHTML = '';
        if (unsubMessages) { unsubMessages(); unsubMessages = null; }
      }
    });

    function aliasFromEmail(email){ return (email || '').split('@')[0]; }

    async function ensureProfile(){
      const uid = auth.currentUser.uid;
      const uref = doc(db, 'users', uid);
      const snap = await getDoc(uref);
      const alias = snap.exists() ? (snap.data().alias || aliasFromEmail(auth.currentUser.email)) : aliasFromEmail(auth.currentUser.email);
      aliasInput.value = alias;
      if (!snap.exists()) await setDoc(uref, { alias });
    }

    // --- MENSAJES ---
    function formatDate(ts){
      if (!ts) return '';
      const d = ts.toDate();
      const fecha = d.toLocaleDateString();
      const hora = d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
      return `${fecha} ${hora}`;
    }

    function suscribirMensajes(){
      const msgsRef = collection(db, 'rooms', ROOM_ID, 'messages');
      const q = query(msgsRef, orderBy('createdAt'));
      if (unsubMessages) unsubMessages();
      unsubMessages = onSnapshot(q, (snap) => {
        messagesEl.innerHTML = '';
        snap.forEach((docu) => {
          const m = docu.data();
          const propio = auth.currentUser && m.uid === auth.currentUser.uid;
          const div = document.createElement('div');
          div.className = 'msg ' + (propio ? 'me' : 'other');
          const alias = m.fromAlias || aliasFromEmail(m.from || '');
          const hora = m.createdAt ? formatDate(m.createdAt) : '';
          div.innerHTML = `${m.text || ''}<div class="meta">${alias} • ${hora}</div>`;
          messagesEl.appendChild(div);
          if (!propio) {
            if (document.hidden && 'Notification' in window && Notification.permission === 'granted') {
              try { new Notification(`Nuevo mensaje de ${alias}`, { body: (m.text || '').slice(0,120) }); } catch {}
            }
            beep();
          }
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    const enviar = async () => {
      const txt = textEl.value.trim();
      if (!txt) return;
      try {
        const uid = auth.currentUser.uid;
        const profile = await getDoc(doc(db, 'users', uid));
        const fromAlias = profile.exists() ? (profile.data().alias || aliasFromEmail(auth.currentUser.email)) : aliasFromEmail(auth.currentUser.email);
        await addDoc(collection(db, 'rooms', ROOM_ID, 'messages'), {
          text: txt,
          uid,
          from: auth.currentUser.email,
          fromAlias,
          createdAt: serverTimestamp()
        });
        textEl.value = '';
      } catch (e) { alert('No se pudo enviar: ' + e.message); }
    };

    sendBtn.onclick = enviar;
    textEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') enviar(); });

    // --- PUSH REALES (FCM) OPCIONAL ---
    enablePushBtn.onclick = async () => {
      try {
        if (!(await isSupported())) return alert('Tu navegador no soporta FCM Web Push.');
        if (!VAPID_KEY || VAPID_KEY.startsWith('PEGAR_AQUI')) return alert('Configurá tu VAPID_KEY pública primero.');
        const reg = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
        const messaging = getMessaging(app);
        const perm = await Notification.requestPermission();
        if (perm !== 'granted') return alert('Permiso de notificaciones denegado.');
        const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
        if (!token) return alert('No se pudo obtener token FCM');
        const uid = auth.currentUser.uid;
        await setDoc(doc(db, 'users', uid, 'tokens', token), { createdAt: serverTimestamp() });
        alert('Push activadas en este dispositivo.');
        onMessage(messaging, (payload) => {
          const title = payload?.notification?.title || 'Nuevo mensaje';
          const body = payload?.notification?.body || '';
          try { new Notification(title, { body }); } catch {}
          beep();
        });
      } catch (e) { alert('Error activando push: '+ e.message); }
    };
  </script>
</body>
</html>
